<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  
  
    
  

  <title>How to setup a pipeline with GitHub (part 2) | Emidio Morgia</title>

  
  <meta name="author" content="Emidio Morgia">
  
  <meta name="description" content="1. OverviewLet&rsquo;s continue with the series of posts dedicated to GitHub Actions with the second article where we will talk about how to build and publish a Docker image from your GitHub repository.
If you alredy know about Docker, containers, images and docker hub you can jump into paragraph 2.
Why is it important to automate the process of creating container images from our code repository? Because in this way, at each commit of our stable branch, we can execute a workflow that, for example: tests our code, creates an image and pushes it on a container registry.">
  <meta name="keywords" content="blog,developer,ddd,ci/cd,microservices,clean architecture">

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to setup a pipeline with GitHub (part 2)"/>
<meta name="twitter:description" content="1. OverviewLet&rsquo;s continue with the series of posts dedicated to GitHub Actions with the second article where we will talk about how to build and publish a Docker image from your GitHub repository.
If you alredy know about Docker, containers, images and docker hub you can jump into paragraph 2.
Why is it important to automate the process of creating container images from our code repository? Because in this way, at each commit of our stable branch, we can execute a workflow that, for example: tests our code, creates an image and pushes it on a container registry."/>

  <meta property="og:title" content="How to setup a pipeline with GitHub (part 2)" />
<meta property="og:description" content="1. OverviewLet&rsquo;s continue with the series of posts dedicated to GitHub Actions with the second article where we will talk about how to build and publish a Docker image from your GitHub repository.
If you alredy know about Docker, containers, images and docker hub you can jump into paragraph 2.
Why is it important to automate the process of creating container images from our code repository? Because in this way, at each commit of our stable branch, we can execute a workflow that, for example: tests our code, creates an image and pushes it on a container registry." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/github-pipeline-2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-18T15:38:30+08:00" />
<meta property="article:modified_time" content="2021-10-18T15:38:30+08:00" />
<meta property="og:see_also" content="http://localhost:1313/posts/github-pipeline-1/" /><meta property="og:see_also" content="http://localhost:1313/posts/github-pipeline-0/" />



  <link rel="stylesheet" href="/css/bootstrap.min.css"  crossorigin="anonymous">
  
  <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet"
    type="text/css">

  
  
  <link rel="stylesheet" href="/sass/main.css">

  
  <link rel="stylesheet" href="/zoomjs/zoom.min.css">

  

  <script src=/js/lazysizes.min.js></script>

  
  

  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  

</head>



<body ontouchstart="">

  
  
  
  
  

  
  
  

  
  





<nav class="navbar navbar-default navbar-custom navbar-fixed-top ">
  <div class="container-fluid">
    
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="http://localhost:1313">Emidio Morgia</a>
    </div>
    
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          
          <li><a href="/" title="Home">Home</a></li>
          
          <li><a href="/archive/" title="Archive">Archive</a></li>
          
          <li><a href="/series/github-actions/" title="Github Actions">Github Actions</a></li>
          
          <li><a href="/about/" title="About">About</a></li>
          
          <li><a href="https://github.com/emidiomorgia/" title="Github">Github</a></li>
          

          <li class="search-icon">
            <a href="javascript:void(0)">
              <i class="fa fa-search"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
    
  </div>
  
</nav>
<script>
  
  
  
  var $body = document.body;
  var $toggle = document.querySelector(".navbar-toggle");
  var $navbar = document.querySelector("#huxblog_navbar");
  var $collapse = document.querySelector(".navbar-collapse");

  var __HuxNav__ = {
    close: function () {
      $navbar.className = " ";
      
      setTimeout(function () {
        
        if ($navbar.className.indexOf("in") < 0) {
          $collapse.style.height = "0px";
        }
      }, 400);
    },
    open: function () {
      $collapse.style.height = "auto";
      $navbar.className += " in";
    },
  };

  
  $toggle.addEventListener("click", function (e) {
    if ($navbar.className.indexOf("in") > 0) {
      __HuxNav__.close();
    } else {
      __HuxNav__.open();
    }
  });

  

  document.addEventListener("click", function (e) {
    if (e.target == $toggle) return;
    if (e.target.className == "icon-bar") return;
    __HuxNav__.close();
  });
</script>
  
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

  
  


<style type="text/css">
  header.intro-header {
    position: relative;
    background-image: url('/ian-taylor-jOqJbvo1P9g-unsplash.jpg');
  }
</style>

<header class="intro-header ">

  <div class="header-mask"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-heading">
          <div class="tags">
            
            <a class="tag" href="/tags/ci/cd/" title="ci/cd">ci/cd</a>
            
            <a class="tag" href="/tags/github-actions/" title="GitHub Actions">GitHub Actions</a>
            
          </div>
          <h1>How to setup a pipeline with GitHub (part 2)</h1>
          <h2 class="subheading"></h2>
          <span class="meta">
            Posted by  Emidio Morgia 
            on Mon, Oct 18, 2021
          </span>
        </div>
      </div>
    </div>
  </div>
</header>


  


<article>
  <div class="container">
    <div class="row">

      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              post-container">
        <h2 id="1-overview">1. Overview<a class="anchorjs-link" href="#1-overview"></a></h2><p>Let&rsquo;s continue with the <a href="/series/github-actions">series of posts</a> dedicated to <strong>GitHub Actions</strong> with the second article where we will talk about how to <em>build</em> and <em>publish</em> a <strong>Docker image</strong> from your <em>GitHub</em> repository.</p>
<p>If you alredy know about <em>Docker</em>, <em>containers</em>, <em>images</em> and <em>docker hub</em> you can jump into <a href="/posts/github-pipeline-2/#2-github-actions-and-docker-how-to-make-github-action-build-and-publish-our-docker-image">paragraph 2</a>.</p>
<p>Why is it important to automate the process of creating container images from our code repository? Because in this way, at each <em>commit</em> of our stable <em>branch</em>, we can execute a <em>workflow</em> that, for example: tests our code, creates an image and pushes it on a container registry. Next, we may have on the production environment, in cloud or on premises, a definition of our application stack (from <em>docker-compose</em> or <em>yaml</em>) that is run by an orchestrator such as <em>Kubernetes</em> or <em>Docker Swarm</em>. In this way, publishing a new version of our application, which could also be composed of more services, would simply mean downloading from the container registry the new versions of the container images defined in the application stack and updating the images of the running containers.</p>
<h2 id="11-what-about-docker-containers-and-images">1.1 What about Docker, containers and images<a class="anchorjs-link" href="#11-what-about-docker-containers-and-images"></a></h2><p>I find the <a href="https://en.wikipedia.org/wiki/Docker_%28software%29" target="_blank">definition on wikipedia</a> complete: <strong>Docker is a set of platform as a service (PaaS) products that use OS-level virtualization to deliver software in packages called containers</strong>. Containers are isolated from one another and bundle their own software, libraries and configuration files;<br>
they can communicate with each other through well-defined channels. Because all of the containers share the services of a single operating system kernel, <strong>they use fewer resources than virtual machines</strong>.</p>
<p>As we can read from <a href="https://www.docker.com/resources/what-container" target="_blank">Docker official web site</a>: A container is a standard unit of software that packages up code and all its dependencies so the application runs <strong>quickly and reliably</strong> from one computing environment to another.</p>
<p>Container images <strong>become containers at runtime</strong> and in the case of <em>Docker</em> containers, images become containers when they run on <a href="https://www.docker.com/products/container-runtime" target="_blank">Docker Engine</a>.</p>
<p>So why use containers and not old fashoned VMs? Again from <a href="https://www.docker.com/resources/what-container" target="_blank">docker web site</a>: Containers are an abstraction at the app layer that packages code and dependencies together. <strong>Multiple containers can run on the same machine and share the OS kernel</strong> with other containers, each running as isolated processes in user space. <strong>Containers take up less space than VMs</strong> (container images are typically tens of MBs in size), <strong>can handle more applications and require fewer</strong> VMs and Operating systems.</p>
<h2 id="12-how-to-build-a-docker-image">1.2 How to build a Docker image<a class="anchorjs-link" href="#12-how-to-build-a-docker-image"></a></h2><p>When building an image, we usually start with a basic one that will be used to create the environment in which the content of our image will run.</p>
<p>For example, if we want to create a <em>container</em> that would run our <em>Angular</em> or <em>React</em> application, we could start from a base image that uses a Linux distribution on which nginx is installed and then go to insert the static files content into the execution folder of the web server.</p>
<p>The definition of the operations to be performed in order to create the new image must be placed inside a file, usually called <strong>Dockerfile</strong> of which you can find the definition of the syntax on the official Docker <a href="https://docs.docker.com/engine/reference/builder/" target="_blank">documentation page</a>.</p>
<p>The way to build a new image from an existing one is very particular and depends on the type of application you are creating. When it comes to using software that must be compiled before it can be run, there are usually two approaches: the first one is to <strong>compile the sources files</strong> before creating the image and then copy the results into the image.</p>
<p>The second approach consists in copying the sources inside the image, and <strong>compiling them into executables using the same environment that will subsequently execute them</strong>. I personally prefer this approach because it guarantees that the execution of the compiled files takes place within the same environment that compiled them from the sources.</p>
<p>Since the creation of the image is not a topic to be explored in this post, I will provide an <strong>example of creating an image starting from the sources</strong> of a web application in <em>dotnet core</em>. There are no limits to what can be built from the base images of the running operating system. A detailed list of examples of how to build images using different languages and frameworks is available at <a href="https://docs.docker.com/samples/" target="_blank">this address</a>.</p>
<p>Suppose we have written an application in <em>dotnet core</em> and are in the folder containing the <em>.csproj</em> file and use &ldquo;<em>aspnetapp</em>&rdquo; as the project name, with this Dockerfile we can create an image that, starting from the sources, <strong>builds and publishes the binary files</strong> by placing them in the &ldquo;out&rdquo; folder and pointing the container execution entrypoint to the <em>dll</em> containing the result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span># syntax=docker/dockerfile:1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>FROM mcr.microsoft.com/dotnet/sdk:5.0 AS build-env
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>WORKDIR /app
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span># Copy csproj and restore as distinct layers
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>COPY *.csproj ./
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>RUN dotnet restore
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span># Copy everything else and build
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>COPY ./ ./
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>RUN dotnet publish -c Release -o out
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span># Build runtime image
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>FROM mcr.microsoft.com/dotnet/aspnet:5.0
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>WORKDIR /app
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>COPY --from=build-env /app/out .
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>ENTRYPOINT [&#34;dotnet&#34;, &#34;aspnetapp.dll&#34;]
</span></span></code></pre></div><p>Dockerfile for build a dotnetcore app from source</p>
<p>The command to use to create the <em>image</em>, assuming you are in the folder containing the file called <strong><em>Dockerfile</em></strong>, is the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker build -t aspnetapp .
</span></span></code></pre></div><p>command for build the image</p>
<p>where &ldquo;<em>aspnetapp</em>&rdquo; is the tag that will uniquely identify the image and &ldquo;<em>.</em>&rdquo; is the parameter that indicates where to find the <em>Dockerfile</em>. For a complete guide see the official docker guide at <a href="https://docs.docker.com/engine/reference/commandline/build/" target="_blank">this address</a>.</p>
<p>Use the following command to check if the image was correctly created:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker images
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>REPOSITORY                              TAG                 IMAGE ID            CREATED             SIZE
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>aspnetapp                               latest              e6780479db63        4 days ago          190MB
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>mcr.microsoft.com/dotnet/aspnet         5.0                 e6780479db63        4 days ago          190MB
</span></span></code></pre></div><p>list all images</p>
<h2 id="13-how-to-run-a-docker-image">1.3 How to run a docker image<a class="anchorjs-link" href="#13-how-to-run-a-docker-image"></a></h2><p>Let&rsquo;s try to run the following command in orter to start the <em>container</em> based on the <em>image</em> we built in the previous point:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span> $ docker run -d -p 8080:80 --name myapp aspnetapp
</span></span></code></pre></div><p>command to run the container</p>
<p>The parameter <em>-d</em> indicates that we want to execute the container in <strong>detached mode</strong>. The parameter <em>-p</em> means: <strong>publish</strong> the container port 80 to host port 8080. The parameter <em>--name myapp</em> indicates the <strong>name of the created container</strong> and the parameter <em>aspnetapp</em> is <strong>the tag of the source image</strong> used to run the container.</p>
<p>You can check the current running or created <em>container</em> with the following  command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker ps -a
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>CONTAINER ID    IMAGE            COMMAND                   CREATED           STATUS     PORTS    NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>0f281cb3af99    aspnetapp        &#34;dotnet NetCore.Dock…&#34;    40 seconds ago    Created             myapp
</span></span></code></pre></div><p>command to show running containers</p>
<p>Find useful info at the <a href="https://docs.docker.com/engine/reference/commandline/run/" target="_blank">official documentation</a>.</p>
<h2 id="14-what-is-docker-hub">1.4 What is Docker Hub<a class="anchorjs-link" href="#14-what-is-docker-hub"></a></h2><p><strong><em>Docker Hub</em></strong> is the world’s largest repository of container images where users get access to <strong><em>free public repositories</em></strong> for storing and sharing Docker image.</p>
<p><em>Docker Hub</em> provides <strong>repositories</strong>, where you can <em>push</em> and <em>pull container images</em>, <strong>automatic builds</strong> from <em>GitHub</em> and Bitbucket, <strong>trigger actions</strong> after a successful <em>push</em> to a repository to integrate <em>Docker Hub</em> with other services.</p>
<p><em>Docker Hub</em> also provides a <em>CLI tool</em> (currently experimental) and an <em>API</em> that allows you to interact with <em>Docker Hub</em>.</p>
<p>From the <a href="https://hub.docker.com/search?type=image" target="_blank">docker hub web</a> site you can <strong>browse all public available images</strong> <strong>that you can pull when executing <em>docker containers</em></strong>.</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="/hub-images.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<p>Public images from docker hub</p>
<p>Once you created an account you can have one private repository and as many public repositories as you want.</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="/hub-repositories.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<p>Find in-depth info at the following <a href="https://docs.docker.com/docker-hub/" target="_blank">link</a>.</p>
<h2 id="15-how-to-push-an-image-into-docker-hub">1.5 How to push an image into docker hub<a class="anchorjs-link" href="#15-how-to-push-an-image-into-docker-hub"></a></h2><p>According to the <a href="https://docs.docker.com/engine/reference/commandline/push/" target="_blank">official documentation</a>, once you have an image with <em>tag</em> you can <strong>push it to a registry</strong> using the following syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span> $ docker push [OPTIONS] NAME[:TAG]
</span></span></code></pre></div><p>docker push syntax</p>
<p>Where <em>NAME</em> is in the form of <em>registry-address:port/account/repository</em>. For example to <em>push</em> on <em>docker hub</em> the <em>image</em> &ldquo;<em>myimage&rdquo;</em> with <em>tag &ldquo;latest&rdquo;</em> for the account &ldquo;<em>myaccount&rdquo;</em> you can use the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span> $ docker push myaccount/myimage:latest
</span></span></code></pre></div><p>In order to <em>push</em> an local <em>image</em> to remote registry, you have to create a tag from the local image.</p>
<p>A first option is to create the &ldquo;<em>myaccount/myimage:latest&rdquo;</em> <strong>while you build</strong> the image using the <em>-t</em> parameter:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker build -t myaccount/myimage .
</span></span></code></pre></div><p>Another option is to create a <em>tag</em> from an <strong>existing</strong> image:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker image tag myimage:latest registry-host:port-number/myaccount/myimage:latest
</span></span></code></pre></div><h2 id="2-github-actions-and-docker-how-to-make-github-action-build-and-publish-our-docker-image">2. Github Actions and Docker: how to make GitHub Action build and publish our docker image<a class="anchorjs-link" href="#2-github-actions-and-docker-how-to-make-github-action-build-and-publish-our-docker-image"></a></h2><p>In the next paragraph we will create the <em>Dockerfile</em> that will produce our <em>image</em>. Following we will create the <em>GitHub Action</em> which will create the <em>Docker image</em> starting from the sources and send the <em>image</em> to the docker hub.</p>
<h2 id="21-what-we-wanto-to-deploy">2.1 What we wanto to deploy<a class="anchorjs-link" href="#21-what-we-wanto-to-deploy"></a></h2><p>The <em>image</em> we are going to create will run an <em>Angular</em> app, published in the form of static <em>html, js and css</em> content, inside an <em>nginx</em> web server.<br>
Referring to our <em>GitHub</em> repository the <em>Angular</em> sources will be located in the &ldquo;<em>src/web&rdquo;</em> directory.</p>
<p>The creation of the <em>Angular</em> build is done by calling the <em>ng build</em> command which will create the compiled files in the <em>dist/web</em> folder. This setting is described in the <em>angular.json</em> file under the <em>outputPath</em> entry.</p>
<h2 id="22-dockerfile-describing-the-image">2.2 Dockerfile describing the image<a class="anchorjs-link" href="#22-dockerfile-describing-the-image"></a></h2><p>The <em>Dockerfile</em> is placed under the root of the project, <em>src/web</em>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span># Stage 1: Compile and Build angular codebase
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span># Use official node image as the base image
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>FROM node:latest as build
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span># Set the working directory
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>WORKDIR /usr/local/app
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span># Add the source code to app
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>COPY ./ /usr/local/app/
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span># Install all the dependencies
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>RUN npm install
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span># Generate the build of the application
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span>RUN npm run build
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span># Stage 2: Serve app with nginx server
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span># Use official nginx image as the base image
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>FROM nginx:latest
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span># Copy the build output to replace the default nginx contents.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>COPY --from=build /usr/local/app/dist/web /usr/share/nginx/html
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span># Expose port 80
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>EXPOSE 80
</span></span></code></pre></div><p>Dockerfile</p>
<p>During the execution of the <em>build</em> of the <em>image</em>, first we create a <em>build environment</em> based on a <em>nodejs</em> image that we use to compile <em>typescript</em> sources to js:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># Use official node image as the base image
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>FROM node:latest as build
</span></span></code></pre></div><p>Then we set the working directory on the <em>build image</em> we just declared and copy all sources from the local folder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># Set the working directory
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>WORKDIR /usr/local/app
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span># Add the source code to app
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>COPY ./ /usr/local/app/
</span></span></code></pre></div><p>Then we install all the <em>npm</em> client packages and run the command to start the <em>Angular</em> compilation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># Install all the dependencies
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>RUN npm install
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span># Generate the build of the application
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>RUN npm run build
</span></span></code></pre></div><p>Now we can declare the <strong>base image</strong> for the execution environment which will be an <em>nginx</em> web server running on <em>linux</em>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># Stage 2: Serve app with nginx server
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span># Use official nginx image as the base image
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>FROM nginx:latest
</span></span></code></pre></div><p>The last thing to do is to copy the content of the output folder produced by <em>Angular</em> into the folder of <em>nginx</em> which will be served by the web server and <em>expose</em> the port 80 outside the container:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># Copy the build output to replace the default nginx contents.
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>COPY --from=build /usr/local/app/dist/web /usr/share/nginx/html
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span># Expose port 80
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>EXPOSE 80
</span></span></code></pre></div><p>If we stopped at this point we could use what we learned in the previous paragraphs to build a <em>docker image</em> starting from the definition of the <em>dockerfile</em>. This image would compile the <em>Angular</em> sources and insert them into the <em>nginx web</em> server. If we wanted, we could locally launch a <em>container</em> based on our new <em>image</em> and map a <em>port</em> of our choice to 80 of the container and visualize the result pointing at <a href="http://localhost/" target="_blank">http://localhost</a>:<port>.</p>
<p><strong>Instead, what we want to achieve is, through the automation of a GitHub Action, the compilation and publish of the resulting image remotely, within GitHub, and then push the image obtained on the Docker Hub so that anyone can download and run our image publicly</strong>.</p>
<h2 id="23-github-action-file">2.3 GitHub Action file<a class="anchorjs-link" href="#23-github-action-file"></a></h2><p>As we said in the previous post, it is possible to create a <em>GitHub Action</em> by choosing from those available in the <em>marketplace</em> or, as in our case, to build a new one using, in some steps, the <em>actions</em> taken from the <em>marketplace</em>.</p>
<p>Let&rsquo;s start by creating a file called <em><strong>web-deploy.yml</strong></em> in the <strong>.github/workflows</strong> folder (we will create it if not existing).</p>
<p>The content of the file for the <em>GitHub Action</em> is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1</span><span># This is a basic workflow to help you get started with Actions
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3</span><span>name: web-deploy CI
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5</span><span># Controls when the workflow will run
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6</span><span>on:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7</span><span>  # Triggers the workflow on push or pull request events but only for the main branch
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8</span><span>  push:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9</span><span>    branches: [ main ]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10</span><span>  pull_request:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11</span><span>    branches: [ main ]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13</span><span>  # Allows you to run this workflow manually from the Actions tab
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14</span><span>  workflow_dispatch:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16</span><span># A workflow run is made up of one or more jobs that can run sequentially or in parallel
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17</span><span>jobs:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18</span><span>  # This workflow contains a single job called &#34;build&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19</span><span>  build:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20</span><span>    # The type of runner that the job will run on
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21</span><span>    runs-on: ubuntu-latest
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23</span><span>    # Steps represent a sequence of tasks that will be executed as part of the job
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24</span><span>    steps:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25</span><span>      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26</span><span>      - uses: actions/checkout@v2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28</span><span>      - name: Login to Docker Hub
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29</span><span>        uses: docker/login-action@v1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30</span><span>        with:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31</span><span>          username: ${{ secrets.DOCKER_HUB_USERNAME }}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32</span><span>          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33</span><span>          
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34</span><span>      - name: Build and push
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35</span><span>        id: docker_build
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36</span><span>        uses: docker/build-push-action@v2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37</span><span>        with:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38</span><span>          context: ./src/web
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39</span><span>          file: ./src/web/Dockerfile
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40</span><span>          push: true
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41</span><span>          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/timetrails-web:latest
</span></span></code></pre></div><p>content of the GitHub Action: web-deploy.yml</p>
<p>After specified the action name, we provide information about <strong>when the workflow will run</strong>. In our case <strong>after a push or pull request accepted on main branch</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span># Controls when the workflow will run
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>on:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>  # Triggers the workflow on push or pull request events but only for the main branch
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>  push:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    branches: [ main ]
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>  pull_request:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>    branches: [ main ]
</span></span></code></pre></div><p>Next thing to do is to <strong>define a job</strong> named &ldquo;build&rdquo; and specify that it will run on ubuntu:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>jobs:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>  # This workflow contains a single job called &#34;build&#34;
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>  build:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>    # The type of runner that the job will run on
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>    runs-on: ubuntu-latest
</span></span></code></pre></div><p>Then we need to declare <strong>some steps in order to accomplish the tasks</strong>. The first one is to <em>checkout</em> the source code from our <em>GitHub</em> repository into the <em>GitHub Action</em> environment. This is done using a marketplace action called &ldquo;<em>actions/checkout</em>&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>- uses: actions/checkout@v2
</span></span></code></pre></div><p>The second step is to <strong>login into the docker hub</strong> with an existing account. Here we use some <strong>secrets stored on <em>GitHub Secrets</em></strong> (secrets.DOCKER_HUB_USERNAME and secrets.DOCKER_HUB_ACCESS_TOKEN).</p>
<p>This is done using a marketplace action called &ldquo;<em>docker/login-action</em>&rdquo; :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>      - name: Login to Docker Hub
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>        uses: docker/login-action@v1
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        with:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>          username: ${{ secrets.DOCKER_HUB_USERNAME }}
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
</span></span></code></pre></div><p>The <em>parameters needed</em> to login into docker hub are provided by &ldquo;<em>username</em>&rdquo; and &ldquo;<em>password</em>&rdquo;</p>
<p>The last thing to do is <strong>build and publish the image into docker hub</strong> and it is done using a marketplace action called &ldquo;<em>docker/build-push-action</em>&rdquo;:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>      - name: Build and push
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>        id: docker_build
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>        uses: docker/build-push-action@v2
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>        with:
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5</span><span>          context: ./src/web
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6</span><span>          file: ./src/web/Dockerfile
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7</span><span>          push: true
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8</span><span>          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/timetrails-web:latest
</span></span></code></pre></div><p>It will need some <em>parameters</em> in order to identify:</p>
<ol>
<li>the starting folder which will be used as context (<em><strong>context</strong></em>)</li>
<li>the path of the dockerfile (<em><strong>file</strong></em>)</li>
<li>the confirm to push (<em><strong>push</strong></em>)</li>
<li>the tag name of the pushed image (<em><strong>tags</strong></em>).</li>
</ol>
<p>In the example we used the name of the project as the image name (<em>timetrails-web</em>) but <strong>you can use the appropriate value as the image tag name</strong>.</p>
<h2 id="24-testing-push-on-commit">2.4 Testing push on commit<a class="anchorjs-link" href="#24-testing-push-on-commit"></a></h2><p>To <strong>verify</strong> that our <em>pipeline</em> works we can <strong>apply a change to the source code within our repository and push the changes</strong>.</p>
<p>Once the code has been <em>pushed</em> to the repository, the <em>GitHub Action</em> will start and we will be able to monitor the progress from the <em>Actions</em> panel.</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="/action-starting.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<p>GitHub Action running after repository push</p>
<p>We can monitor the execution of our action by clicking on the relevant line in the action list by <strong>choosing the one that shows the title of the commit we used</strong> to activate the pipeline.</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="/action-finished.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<p>The summary of GitHub Ation executed</p>
<p>We can see the detail of each step declared in the file <em>web-deploy.yml</em>.</p>
<p>Finally, in the <em>docker hub</em>, we can check if the image was correctly pushed (in our case the image is <em>timetrails-web</em>):</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="/docker-hub-after-action.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<h2 id="25-run-the-image-from-docker-hub">2.5 Run the image from docker hub<a class="anchorjs-link" href="#25-run-the-image-from-docker-hub"></a></h2><p>Now that we have built the image and pushed it into the docker hub we can try to pull the image in docker and run the container at a specified free port with the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker run --name timetrails-web -p 8080:80 emidio78/timetrails-web
</span></span></code></pre></div><p>You can <strong>check if the container is running</strong> with the following command and you should receive the following result telling yout that the image was pulled and the container is running at port 8080:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1</span><span>$ docker ps
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2</span><span>
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3</span><span>CONTAINER ID   IMAGE                     COMMAND                  CREATED              STATUS              PORTS                                   NAMES
</span></span><span style="display:flex;"><span style="white-space:pre;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4</span><span>e0107a4d4c93   emidio78/timetrails-web   &#34;/docker-entrypoint.…&#34;   About a minute ago   Up About a minute   0.0.0.0:8080-&gt;80/tcp, :::8080-&gt;80/tcp   timetrails-web
</span></span></code></pre></div><p><strong>Opening the browser at <a href="http://localhost:8080/" target="_blank">http://localhost:8080</a></strong> you should see the default Angular app generated by Angular cli:</p>
<p><figure>
  <a class="paragraph-image">
    <img data-src="/image-running.png" data-action="zoom" alt=""  class="lazyload">
  </a>
  
</figure></p>
<p>Stay tuned for the third and final part of the series where we will talk about <strong>how to run the docker image inside a docker-compose stack from an Ubuntu server</strong> and <strong>how to expose our service through a reverse proxy</strong> such as NGINX.he project) and then <strong>publish the content</strong> on a Docker Hub repository.</p>


        <hr style="visibility: hidden;" />
        <ul class="pager">
          
          <li class="previous">
            <a href="/posts/github-pipeline-1/" data-toggle="tooltip" data-placement="top" title="How to setup a pipeline with GitHub (part 1)">
              Previous<br>
              <span>How to setup a pipeline with GitHub (part 1)</span>
            </a>
          </li>
          
          
        </ul>
        <hr style="visibility: hidden;" />

        
        






      </div>

      
      
      
      <div class="
              col-lg-2 col-lg-offset-0
              visible-lg-block
              sidebar-container
              catalog-container">
        <div class="side-catalog">
          <hr class="hidden-sm hidden-xs">
          <h5>
            <a class="catalog-toggle" href="#">CATALOG</a>
          </h5>
          <ul class="catalog-body"></ul>
        </div>
      </div>
      
      
      <div class="
              col-lg-8 col-lg-offset-2
              col-md-10 col-md-offset-1
              sidebar-container">

        
        
        <section>
  
  
  <hr class="hidden-sm hidden-xs">
  
  <h5>FEATURED TAGS</h5>
  <div class="tags">
    
    <a href="/tags/blog/">blog</a>
    
    <a href="/tags/ci/cd/">ci/cd</a>
    
    <a href="/tags/github-actions/">GitHub Actions</a>
    
  </div>
</section>

        
        

      </div>
    </div>
  </div>
</article>



  
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        
        


<ul class="list-inline text-center">

  
  <li>
    <a href=/index.xml>
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a href="https://twitter.com/emidiomorgia">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  
  <li>
    <a target="_blank" href="https://www.facebook.com/emidio.morgia">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://github.com/emidiomorgia">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  <li>
    <a target="_blank" href="https://www.linkedin.com/in/emidio-morgia-93127a35">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
</ul>
        <p class="copyright text-muted">
          Emidio Morgia  
          <br>
          Powered by <a href="https://gohugo.io">Hugo</a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js crossorigin="anonymous"></script>



<script src="/js/hux-blog.min.73a6a8d8df45293e042d15867416f603045bbeb98406731e5022d6c60388cd9d.js"></script>


<script src=/js/simple-jekyll-search.min.js></script>


<script src="/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js"></script>






<script type="text/javascript">
  function generateCatalog(selector) {
    _containerSelector = 'div.post-container'
    
    var P = $(_containerSelector), a, n, t, l, i, c;
    a = P.find('h1,h2,h3,h4');
    
    $(selector).html('')
    
    a.each(function () {
      n = $(this).prop('tagName').toLowerCase();
      i = "#" + $(this).prop('id');
      t = $(this).text();
      c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
      l = $('<li class="' + n + '_nav"></li>').append(c);
      $(selector).append(l);
    });
    return true;
  }

  generateCatalog(".catalog-body");

  
  $(".catalog-toggle").click((function (e) {
    e.preventDefault();
    $('.side-catalog').toggleClass("fold")
  }))
</script>


<script type="text/javascript" src='/js/jquery.nav.min.ade6bde8f9fcc6a4b40852cb892e9f5912340ab8fe1305149d917fdd16fffd8d.js'></script>
<script>
   $(document).ready( function () {
    $('.catalog-body').onePageNav({
      currentClass: "active",
      changeHash: !1,
      easing: "swing",
      filter: "",
      scrollSpeed: 700,
      scrollOffset: 0,
      scrollThreshold: .2,
      begin: null,
      end: null,
      scrollChange: null,
      padding: 80
    });
  });
</script>









<script src="/zoomjs/zoom.min.js"></script>

</body>

</html>